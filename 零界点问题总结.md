# 临界点问题思考
背景：
公司项目年度活动，需求如下：

- 1.用户给主播送礼，每收一个礼物获得一积分 
- 2.活动持续15天 每天主播会进行排名，根据排名进行晋级，未晋级的主播视为淘汰，不再记录积分。第一天N进50 ，第二天50进30......
- 3.每次晋级后积分重新计算


--------------------------------

## 整体流程

```sequence
礼物处理流程：前端->nginx负载->直播间服务模块->礼物Mq->活动服务模块->监听礼物消息->记录主播收礼积分(redis sortset)->每日0点结算晋级榜单
```


## 处理逻辑

其中直播间服务模块主要负责将礼物消息发送到mq里，真正的处理逻辑在活动服务模块里，对礼物消息进行监听，来一个处理一个。另外定时任务0点进行晋级处理。

版本1:

- 1.礼物消息到来，直接记录到redis，判断当前时间属于哪一个轮次 
- 2.定时任务0:0:0 对redis读取 上一个轮次的数据，并取晋级名单，重新写入redis，生成新的榜单数据，积分为0。
- 3.当结算后，礼物消息进来时，判断主播是否在新的榜单里，如果在则说明主播晋级，对积分累计

问题：

- 礼物消息未做时间判断，因为消息存在延后，直接使用系统时间会在0:0:0这个时间点存在问题（本平台用户超喜欢59:59秒这种时间点搞事情），礼物实际为0:0:0之前赠送，但礼物经过网络以及各个服务模块到达真正处理逻辑时可能会在0:00:00 002 毫秒级到达，按照系统时间会算成0:00：00后的礼物，这时候可能出现的情况有：1.主播晋级礼物算成了后一轮的 2.主播不晋级，前一轮后一轮都没有算 。数据丢失或者有问题影响实际排名情况

版本2:

- 1.根据礼物消息时间对礼物进行轮次判断，将礼物加入属于他的轮次中，解决了版本1中礼物时间的问题，也不会造成数据异常。其他步骤处理一致

问题：

- 礼物榜单数据 0:00:00 切榜,生成新的redis sortset，根据sortset 中是否含有某个userid 判断是否晋级，存在一定的问题。礼物A于23:59:59秒（A轮次）赠送，礼物消息时间也是23:59:59秒，逻辑处理时间为：0:0:0 020 毫秒级，根据消息时间将礼物归纳于A轮次，记录主播积分，而非记录在0:0:0开始的B轮次。
在处理A礼物之前，榜单为 A比B多一分，但是当处理完之后，B比A 多2分，榜单排名发生变化。由于榜单切榜是一个定时线程单独处理，当0:0:0切榜时，A礼物尚未处理，A晋级B未晋级，但是当A礼物处理后榜单发生变化，B应该晋级，但却没有写入到晋级名单内，造成数据异常。这里面存在一定的似并发问题，两个线程对榜单数据进行读取修改，由于礼物延迟造成数据不一致。

版本3:

- 改进：将切榜动作延迟一定的秒数(根据情况而定，用户可以接受一定的秒级延迟)，使得0:00:00之前的礼物消息全部处理完毕


仍可能有问题的地方：

- 礼物时间顺序是否有保证（本平台的礼物顺序是得到保证的）

- 消息队列是否会发生长时间延迟，例如：大于 一分钟 或者更久，如果这样对实时榜单排名影响巨大，服务基本不可用（公司平台，积分延迟在毫秒级范围内，可以接受）



## 总结

- 1.对于消息队列延迟问题应该时刻注意

- 2.当项目中存在多线程时，要画一个线程 资源图，看是否会存在多线程处理统一资源问题，以及是否会造成并发问题

- 3.对于某个临界点，要特别注意他前后相关的处理逻辑，在合适的情况下可以考虑做加减法。本例子中采用加法，对实时榜单进行一定延时。对于一些系统，比如秒杀，如果系统复杂，不能做到整整意义上的精确，可以考虑做一定的减法，或者加法，指定秒杀数量增多或者减少等等。。。。。



